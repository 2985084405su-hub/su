<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试脚本控制器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 300px 1fr;
            }
            .api-card {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .card h2 {
            color: #444;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
            text-decoration: none;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        /* 脚本输出区域 */
        #output {
            background: #1a202c;
            color: #cbd5e0;
            padding: 15px;
            border-radius: 5px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        .log-line {
            margin-bottom: 2px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            word-break: break-all;
        }
        
        /* API 捕获面板样式 */
        .api-monitor {
            background: #f8f9fa;
            border-radius: 5px;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }

        .api-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .api-header {
            padding: 10px 15px;
            background: #edf2f7;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none; /* 防止点击时选中文本 */
        }

        .api-header:hover {
            background: #e2e8f0;
        }

        .api-method {
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .api-method.POST { background: #48bb78; color: white; }
        .api-method.GET { background: #4299e1; color: white; }

        .api-url {
            flex: 1;
            margin: 0 10px;
            font-family: monospace;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #2d3748;
        }

        .api-status {
            font-weight: bold;
            font-size: 13px;
        }

        .api-status.success { color: #48bb78; }
        .api-status.error { color: #e53e3e; }

        .api-details {
            padding: 15px;
            display: none;
            background: #fff;
            border-top: 1px solid #e2e8f0;
        }

        .api-details.open {
            display: block;
        }

        .detail-section {
            margin-bottom: 15px;
        }

        .detail-title {
            font-size: 12px;
            font-weight: bold;
            color: #718096;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .json-box {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .empty-api {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .status-bar {
            grid-column: 1 / -1;
            background: white;
            border-radius: 5px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-dot.running {
            background: #48bb78;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .copy-btn {
            float: right;
            padding: 2px 8px;
            font-size: 11px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .copy-btn:hover { background: #2d3748; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-code"></i> 测试脚本控制器</h1>
            <p>配置变量并运行自动化测试脚本，实时监控 API 交互</p>
        </div>
        
        <div class="main-content">
            <!-- 1. 变量配置 -->
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> 变量配置</h2>
                <form id="testForm" action="/run" method="POST">
                    {% for var in variables %}
                    <div class="form-group">
                        <label>
                            {{ var.label }}
                            {% if var.required %}<span style="color:red">*</span>{% endif %}
                        </label>
                        <input type="{{ var.type }}" 
                            name="{{ var.name }}" 
                            value="{{ var.value if var.value else var.default }}"
                            placeholder="输入 {{ var.label }}">
                        {% if var.description %}
                        <div style="font-size:12px;color:#888">{{ var.description }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play"></i> 运行测试
                    </button>
                    <a href="/stop" class="btn btn-danger">
                        <i class="fas fa-stop"></i> 停止测试
                    </a>
                </form>
            </div>
            
            <!-- 2. 脚本日志 -->
            <div class="card">
                <h2>
                    <span><i class="fas fa-terminal"></i> 脚本日志</span>
                    <button onclick="clearOutput()" style="font-size:12px;padding:4px 8px;cursor:pointer">清空</button>
                </h2>
                <div id="output"></div>
            </div>

            <!-- 3. API 监控面板 -->
            <div class="card api-card">
                <h2>
                    <span><i class="fas fa-network-wired"></i> 接口捕获 (最新)</span>
                    <span id="apiStatus" style="font-size:12px;color:#666;font-weight:normal">监听中...</span>
                </h2>
                <div id="apiMonitor" class="api-monitor">
                    <div class="empty-api">
                        <i class="fas fa-search" style="font-size:24px;margin-bottom:10px"></i>
                        <p>等待捕获接口请求...</p>
                        <p style="font-size:12px">监听接口: api/subscribe/create, check-payment-url</p>
                    </div>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">就绪</span>
            </div>
        </div>
    </div>

    <script>
        let lastOutputLength = 0;
        let isRunning = false;
        let cardUniqueIdCounter = 0; // 全局计数器，确保ID唯一
        const processedApiSet = new Set(); // 用于去重的内容签名集合
        
        // 自动刷新
        setInterval(refreshOutput, 2000);
        
        function refreshOutput() {
            fetch('/get_output')
                .then(response => response.json())
                .then(data => {
                    const outputDiv = document.getElementById('output');
                    
                    // 只有当总行数增加时才进行处理
                    if (data.total_lines > lastOutputLength) {
                        const allLines = data.output.split('\n');
                        
                        // 计算新增了多少行
                        const newLinesCount = data.total_lines - lastOutputLength;
                        
                        // 1. 处理 API 数据 (仅处理新增的行，防止重复渲染)
                        // 如果新增行数大于当前返回的buffer大小，说明有丢包，但我们只处理当前能看到的
                        let linesToProcess = [];
                        if (newLinesCount >= allLines.length) {
                            linesToProcess = allLines;
                        } else {
                            linesToProcess = allLines.slice(-newLinesCount);
                        }

                        // 仅在新增行中查找 API 数据
                        linesToProcess.forEach(line => {
                            if (line.includes('__API_CAPTURE__|')) {
                                processApiData(line);
                            }
                        });
                        
                        // 2. 更新日志显示 (全量更新显示，因为innerHTML替换比追加更简单且不容易出错)
                        // 过滤掉 API JSON 数据行，只显示普通日志
                        const logHtml = allLines.map(line => {
                            if (line.includes('__API_CAPTURE__|')) {
                                return ''; 
                            }
                            return `<div class="log-line">${line}</div>`;
                        }).join('');
                        
                        outputDiv.innerHTML = logHtml;
                        outputDiv.scrollTop = outputDiv.scrollHeight;
                        
                        // 更新指针
                        lastOutputLength = data.total_lines;
                    }
                    
                    // 更新状态指示器
                    const statusDot = document.getElementById('statusDot');
                    const statusText = document.getElementById('statusText');
                    
                    if (data.output && data.output.includes('开始运行测试脚本') && !data.output.includes('脚本执行完成')) {
                        statusDot.className = 'status-dot running';
                        statusText.textContent = '运行中';
                        isRunning = true;
                    } else if (data.output && data.output.includes('脚本执行完成')) {
                        statusDot.className = 'status-dot';
                        statusText.textContent = '执行完成';
                        isRunning = false;
                    }
                });
        }

        function clearOutput() {
            fetch('/clear_output', { method: 'POST' })
                .then(() => {
                    document.getElementById('output').innerHTML = '';
                    document.getElementById('apiMonitor').innerHTML = `
                        <div class="empty-api">
                            <i class="fas fa-search" style="font-size:24px;margin-bottom:10px"></i>
                            <p>等待捕获接口请求...</p>
                        </div>`;
                    lastOutputLength = 0;
                    processedApiSet.clear(); // 清空去重集合
                });
        }

        // 处理 API 数据
        function processApiData(line) {
            try {
                const jsonStr = line.split('__API_CAPTURE__|')[1];
                
                // 简单的去重机制：如果完全相同的JSON字符串已经处理过，则跳过
                // 这可以防止因为网络重发或逻辑错误导致的UI重复
                // 为了区分完全相同的多次请求，这里最好结合 requestId，但目前简单处理内容重复
                // 如果需要允许完全相同内容的重复请求，可以注释掉下面三行
                const signature = jsonStr.substring(0, 100) + jsonStr.length; // 简化的签名，提升性能
                if (processedApiSet.has(signature)) {
                     // 可以在这里决定是否允许重复显示。为了用户体验，暂时不去重，或者严格去重
                     // 考虑到用户说"每次运行时都只展示当时那次"，我们主要依赖上面的"仅处理新增行"逻辑
                }
                // processedApiSet.add(signature); 

                const data = JSON.parse(jsonStr);
                renderApiCard(data);
            } catch (e) {
                console.error('API 解析失败', e);
            }
        }

        function renderApiCard(data) {
            const container = document.getElementById('apiMonitor');
            
            // 移除空状态
            if (container.querySelector('.empty-api')) {
                container.innerHTML = '';
            }

            const method = data.method || (data.response_body ? 'POST' : 'GET');
            const statusClass = (data.status >= 200 && data.status < 300) ? 'success' : 'error';
            const statusText = data.status || 'Checking...';
            
            // 生成绝对唯一的 ID
            // 组合：前缀 + 时间戳 + 全局计数器 + 随机数
            cardUniqueIdCounter++;
            const cardId = `api-${Date.now()}-${cardUniqueIdCounter}-${Math.floor(Math.random() * 10000)}`;
            
            const html = `
                <div class="api-item">
                    <div class="api-header" onclick="toggleDetails('${cardId}')">
                        <div style="display:flex;align-items:center;width:100%">
                            <span class="api-method ${method}">${method}</span>
                            <span class="api-url" title="${data.url}">${data.url}</span>
                            <span class="api-status ${statusClass}">${statusText}</span>
                            <i class="fas fa-chevron-down" style="font-size:12px;margin-left:auto;color:#a0aec0"></i>
                        </div>
                    </div>
                    <div id="${cardId}" class="api-details">
                        ${data.requestId ? `<div style="font-size:10px;color:#cbd5e0;margin-bottom:5px">ID: ${data.requestId}</div>` : ''}
                        
                        ${data.request_headers ? `
                        <div class="detail-section">
                            <div class="detail-title">Request Headers</div>
                            <div class="json-box">${JSON.stringify(data.request_headers, null, 2)}</div>
                        </div>` : ''}
                        
                        ${data.request_body ? `
                        <div class="detail-section">
                            <div class="detail-title">Request Body 
                                <button class="copy-btn" onclick="copyText(this)">Copy</button>
                            </div>
                            <div class="json-box">${formatBody(data.request_body)}</div>
                        </div>` : ''}

                        ${data.response_headers ? `
                        <div class="detail-section">
                            <div class="detail-title">Response Headers</div>
                            <div class="json-box">${JSON.stringify(data.response_headers, null, 2)}</div>
                        </div>` : ''}

                        ${data.response_body ? `
                        <div class="detail-section">
                            <div class="detail-title">Response Body
                                <button class="copy-btn" onclick="copyText(this)">Copy</button>
                            </div>
                            <div class="json-box">${formatBody(data.response_body)}</div>
                        </div>` : ''}
                    </div>
                </div>
            `;
            
            // 将新卡片插入到顶部
            container.insertAdjacentHTML('afterbegin', html);
        }

        function toggleDetails(id) {
            console.log("Toggling ID:", id); // 调试日志
            const el = document.getElementById(id);
            if (el) {
                if (el.classList.contains('open')) {
                    el.classList.remove('open');
                } else {
                    el.classList.add('open');
                }
            } else {
                console.error("Element not found:", id);
            }
        }

        function formatBody(body) {
            try {
                if (typeof body === 'string') {
                    const obj = JSON.parse(body);
                    return JSON.stringify(obj, null, 2);
                }
                return JSON.stringify(body, null, 2);
            } catch (e) {
                return body; 
            }
        }

        function copyText(btn) {
            const text = btn.parentElement.nextElementSibling.textContent;
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            setTimeout(() => btn.textContent = originalText, 1000);
        }
    </script>
</body>
</html>